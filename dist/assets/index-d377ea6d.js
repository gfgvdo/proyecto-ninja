(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const c of o.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function r(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(n){if(n.ep)return;n.ep=!0;const o=r(n);fetch(n.href,o)}})();function B(e,t){return Array.isArray(t)?D(e,t):M(e,t)}function D(e,t){let r=0;return e.replace(/\?/g,s=>r<t.length?l(t[r++]):s)}function M(e,t){return e.replace(/:(\w+)/g,(r,s)=>$(t,s)?l(t[s]):r)}function $(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function l(e){return e==null?"null":typeof e=="number"?String(e):typeof e=="boolean"?e?"true":"false":typeof e=="string"?h(e):Array.isArray(e)?e.map(l).join(", "):e instanceof Date?h(e.toISOString().replace("Z","")):h(e.toString())}function h(e){return`'${C(e)}'`}const P=/[\0\b\n\r\t\x1a\\"']/g;function C(e){return e.replace(P,F)}function F(e){switch(e){case'"':return'\\"';case"'":return"\\'";case`
`:return"\\n";case"\r":return"\\r";case"	":return"\\t";case"\\":return"\\\\";case"\0":return"\\0";case"\b":return"\\b";case"":return"\\Z";default:return""}}const J=new TextDecoder("utf-8");function g(e){return e?J.decode(Uint8Array.from(Y(e))):""}function Y(e){return e.split("").map(t=>t.charCodeAt(0))}const z="1.11.0";class d extends Error{constructor(t,r,s){super(t),this.status=r,this.name="DatabaseError",this.body=s}}const b={as:"object"};class q{constructor(t){this.conn=t}async execute(t,r=null,s=b){return this.conn.execute(t,r,s)}}function G(e){return e==="http:"?e:"https:"}function K(e){const t=`${G(e.protocol)}//`;return new URL(e.pathname,`${t}${e.host}`).toString()}class w{constructor(t){var r;if(this.session=null,this.config={...t},typeof fetch<"u"&&((r=this.config).fetch||(r.fetch=fetch)),t.url){const s=new URL(t.url);this.config.username=s.username,this.config.password=s.password,this.config.host=s.hostname,this.url=K(s)}else this.url=new URL(`https://${this.config.host}`).toString()}async transaction(t){const r=new w(this.config),s=new q(r);try{await s.execute("BEGIN");const n=await t(s);return await s.execute("COMMIT"),n}catch(n){throw await s.execute("ROLLBACK"),n}}async refresh(){await this.createSession()}async execute(t,r=null,s=b){const n=new URL("/psdb.v1alpha1.Database/Execute",this.url),o=this.config.format||B,c=r?o(t,r):t,u=await T(this.config,n,{query:c,session:this.session}),{result:a,session:m,error:p,timing:A}=u;if(m&&(this.session=m),p)throw new d(p.message,400,p);const N=a!=null&&a.rowsAffected?parseInt(a.rowsAffected,10):0,O=(a==null?void 0:a.insertId)??"0",f=(a==null?void 0:a.fields)??[];for(const i of f)i.type||(i.type="NULL");const L=s.cast||this.config.cast||Q,y=a?H(a,L,s.as||"object"):[],S=f.map(i=>i.name),x=(i,{name:U,type:j})=>({...i,[U]:j}),E=f.reduce(x,{}),R=A??0;return{headers:S,types:E,fields:f,rows:y,rowsAffected:N,insertId:O,size:y.length,statement:c,time:R*1e3}}async createSession(){const t=new URL("/psdb.v1alpha1.Database/CreateSession",this.url),{session:r}=await T(this.config,t);return this.session=r,r}}async function T(e,t,r={}){const s=btoa(`${e.username}:${e.password}`),{fetch:n}=e,o=await n(t.toString(),{method:"POST",body:JSON.stringify(r),headers:{"Content-Type":"application/json","User-Agent":`database-js/${z}`,Authorization:`Basic ${s}`},cache:"no-store"});if(o.ok)return await o.json();{let c=null;try{const u=(await o.json()).error;c=new d(u.message,o.status,u)}catch{c=new d(o.statusText,o.status,{code:"internal",message:o.statusText})}throw c}}function W(e){return new w(e)}function V(e,t,r){const s=I(t);return e.map((n,o)=>r(n,s[o]))}function Z(e,t,r){const s=I(t);return e.reduce((n,o,c)=>(n[o.name]=r(o,s[c]),n),{})}function H(e,t,r){const s=e.fields;return(e.rows??[]).map(o=>r==="array"?V(s,o,t):Z(s,o,t))}function I(e){const t=e.values?atob(e.values):"";let r=0;return e.lengths.map(s=>{const n=parseInt(s,10);if(n<0)return null;const o=t.substring(r,r+n);return r+=n,o})}function Q(e,t){if(t===""||t==null)return t;switch(e.type){case"INT8":case"INT16":case"INT24":case"INT32":case"UINT8":case"UINT16":case"UINT24":case"UINT32":case"YEAR":return parseInt(t,10);case"FLOAT32":case"FLOAT64":return parseFloat(t);case"DECIMAL":case"INT64":case"UINT64":case"DATE":case"TIME":case"DATETIME":case"TIMESTAMP":case"BLOB":case"BIT":case"VARBINARY":case"BINARY":case"GEOMETRY":return t;case"JSON":return JSON.parse(g(t));default:return g(t)}}export{W as c};
